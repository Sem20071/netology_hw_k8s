# Домашнее задание к занятию «Компоненты Kubernetes»

## Задание. Необходимо определить требуемые ресурсы
Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения.
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий.
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.
   
Порядок выполнения: 
1. Сначала сделайте расчёт всех необходимых ресурсов.
2. Затем прикиньте количество рабочих нод, которые справятся с такой нагрузкой.
3. Добавьте к полученным цифрам запас, который учитывает выход из строя как минимум одной ноды.
4. Добавьте служебные ресурсы к нодам. Помните, что для разных типов нод требовния к ресурсам разные.
5. В результате должно быть указано количество нод и их параметры.
   
## Ответ:
### 1. Расчёт всех необходимых ресурсов.

| Компонент | Количество копий | CPU на копию | Суммарный CPU | ОЗУ на копию | Суммарное ОЗУ |
| ----------- | ----------- | ----------- | ----------- | ----------- | ----------- |
| База данных | 3 | 1 ядро | 3 ядра | 4 Гб | 12 Гб |
| Кеш | 3 | 1 ядро | 3 ядра | 4 Гб | 12 Гб |
| Фронтенд | 5 | 0.2 ядра | 1 ядро | 50 Mb | 250 Mb |
| Бекенд | 10 | 1 ядро | 10 ядрер |  600 Mb | 6 Гб |
| ИТОГО: |  |  | 17 ядрер |  | 30.25 Гб |

#### Итого для приложения: 17 ядер CPU и 30.25 ГБ ОЗУ.

### 2. Количество рабочих нод.
При расчете колличества рабочих нод нужно читывать:
- Отказоустойчивость Stateful-сервисов (БД и Кеш): Имея по 3 реплики, для их корректной работы при потери одной ноды оптимально иметь минимум 3 ноды.
- Распределение нагрузки: 21 под (3+3+5+10) хорошо распределяются на 3 ноды (в среднем по 7 подов на ноду).
- Запас ресурсов на ноде: Рекомендуется оставлять 10-20% ресурсов ноды незанятыми на случай пиковых нагрузок и для работы систем Kubernetes

Расчёт на 3 ноды:
- Суммарные требования: 17 ядер / 30.25 ГБ ОЗУ.
- На одну ноду в среднем: ~5.67 ядра / ~10.08 ГБ ОЗУ.
- С учетом запаса в 20% минимальная мощность одной ноды должна быть: 7.1 ядра и 12.6 ГБ ОЗУ.

Таким образом, 3 ноды с характеристиками 8 ядер CPU и 16 ГБ ОЗУ каждая должны справиться с нагрузкой.

### 3. Расчет запаса на выход ис строя одной ноды.
При выходе из строя одной из нод, её ногрузка должна равномерно распределиться между оставшимися нодами:
- Вся нагрузка (17 ядер / 30.25 ГБ ОЗУ) должна уместиться на 2 оставшихся нодах.
- На одну ноду в этом аварийном режиме придется: 17 / 2 = 8.5 ядра и 30.25 / 2 = 15.125 ГБ ОЗУ
- Не забываем про правило 20% запаса на ноде на случай пиковых нагурзок и для работ систем Kubernetes

Минимальные требования к одной ноде с учетом отказа:
- CPU: 8.5 ядра / 0.8 ≈ 10.625 ядер
- ОЗУ: 15.125 ГБ / 0.8 ≈ 18.9 ГБ
Это означает, что для обеспечения отказоустойчивости при потере одной ноды, каждая нода должна иметь не менее 11 ядер и 20 ГБ ОЗУ.

### 4. Добавляем служебные ресурсы к нодам.
- Системные процессы ОС и container runtime: ~0.5 ядра, 1-2 ГБ ОЗУ.
- Служебные поды Kubernetes (kube-proxy, CNI, CoreDNS): ~0.25 ядра, 0.5 ГБ ОЗУ.
- Итого на служебные нужды: закладываем ~0.75 ядра и ~2.5 ГБ ОЗУ на каждую ноду.

Финальный расчет ресурсов на одну ноду:
- CPU: 11 ядер (от приложений) + 0.75 ядра (служебные) = 11.75 ядер
- ОЗУ: 20 ГБ (от приложений) + 2.5 ГБ (служебные) = 22.5 ГБ
Округляем в большую сторону.

### 5. Итоговые параметры кластера.

| Параметр | Значение |
|----------|----------|
| Количество рабочих нод | 3 |
| Конфигурация одной ноды | 12 ядер CPU, 24 ГБ ОЗУ |
| Суммарные ресурсы кластера | 36 ядер CPU, 72 ГБ ОЗУ |

## Стоимость одной ноды в YC составляем примерно 15724 руб/мес стоимость всего кластера 47172 руб/мес.
