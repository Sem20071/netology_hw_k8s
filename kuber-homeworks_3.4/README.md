# Домашнее задание к занятию «Обновление приложений»

## Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор
1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Вам нужно объяснить свой выбор стратегии обновления приложения.

## Ответ:
Обоснование выбора:
1. Rolling Update не подойдёт из за проблем, при мажорном обновлении, с несовместимостью. В данной стратегии обновления поочередно заменяются поды с v1 на v2. Это значит что некоторое время будут одновременно доступны обе версии приложения, а это может привести к:
    - Ошибкам взаимодействия между версиями
    - Рассогласованию данных
    - Частичным отказам функциональности

2. Стратегия Recreate подходит под описанные требования. В момент обновления сервис будет недоступен некоторое время. Но это неизбежно при мажорных несовместимых обновлениях.

3. Стратегия Blue-green не проходит под 20% запас по ресурсам. Возможно уменьшение количества реплик сервиса а затем развертывания новой версии сервиса и переключением трафика на новую версию. Моменты которые стоит учесть:
- такое обновление, с уменьшением количества реплик, неизбежно приведет к деградации сервиса. 
- нет точной информации по количеству реплик, что важно при расчете общего потребления ресурсов при одновременной работе обоих версий сервисов.
- возможные пиковые нагрузки могут превысить 20% запас.

4. Canary и A/B-тестирование чаще использую для тестирования обновления. 

Вывод:
Если временная недоступность сервиса не является критической, под требуемые условия подойдёт стратегия обновления Recreate.


## Задание 2. Обновить приложение
1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
4. Откатиться после неудачного обновления.

## Ответ:

1. [Файл-манифест](https://github.com/Sem20071/netology_hw_k8s/blob/main/kuber-homeworks_3.4/deployment-nginx-multitool.yaml) и deployment приложения с контейнерами nginx и multitool созданы.
    ![Скриншот консоли 1](https://github.com/Sem20071/netology_hw_k8s/blob/main/kuber-homeworks_3.4/images/kuber-homeworks_3.4-2-1.png)

2. Для обновления выбрана стратегия RollingUpdate. Nginx обнавлен до версии 1.20. Во время обновления 3 из 5 подов остаются доступными. Версия nginx была изменена в файл-манифесте.
    ![Скриншот консоли 2](https://github.com/Sem20071/netology_hw_k8s/blob/main/kuber-homeworks_3.4/images/kuber-homeworks_3.4-2-2.png)

3. Судя по всему задание подразумевает обновление на не существующую версию, т.к. обновление должно завершиться с ошибкой. Обновлялся до версии 1.32 (Не существующая). Процесс обновления не завершился, так как новые поды не смогли запуститься из за ошибки. Откатился до версии 1.20.
    ![Скриншот консоли 3](https://github.com/Sem20071/netology_hw_k8s/blob/main/kuber-homeworks_3.4/images/kuber-homeworks_3.4-2-4.png)

## Задание 3*. Создать Canary deployment
1. Создать два deployment'а приложения nginx.
2. При помощи разных ConfigMap сделать две версии приложения — веб-страницы.
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.

## Ответ:

1. Включаем репозиторий community:
   `microk8s enable community`

2. Устанавливаем Traefik:
    `microk8s enable traefik`

3. Проверяем установку:
```
microk8s kubectl get pods -n traefik
microk8s kubectl get svc -n traefik
```

4. Деплоим наши [traefik.yaml](https://github.com/Sem20071/netology_hw_k8s/blob/main/kuber-homeworks_3.4/task3/traefik.yaml) и [ingress.yaml](https://github.com/Sem20071/netology_hw_k8s/blob/main/kuber-homeworks_3.4/task3/ingress.yaml)

5. Проверяем на каком порту работает traefik 
`microk8s kubectl get svc -n traefik`

6. Проверяем работу сервиса и как распределяется трафик.
`curl http://127.0.0.1:30836`